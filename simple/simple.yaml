tosca_definitions_version: cloudify_dsl_1_0

imports:
    - http://www.getcloudify.org/spec/cloudify/3.1/types.yaml
    - http://www.getcloudify.org/spec/fabric-plugin/1.1/plugin.yaml


inputs:

    public_ip:
        default: 11.0.0.7
        type: string

    private_ip:
        default: localhost
        type: string

    ssh_user:
        default: vagrant
        type: string

    ssh_key_filename:
        default: ~/work/vagrant/cloudify-manager/insecure_private_key
        type: string

    cloudify_packages:
        default:
            server:
                components_package_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/nightly/cloudify-components_amd64.deb
                core_package_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/nightly/cloudify-core_amd64.deb
                ui_package_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/nightly/cloudify-ui_amd64.deb
            agents:
                ubuntu_agent_url: http://gigaspaces-repository-eu.s3.amazonaws.com/org/cloudify3/nightly/cloudify-ubuntu-agent_amd64.deb

    cloudify:
        default:
            resources_prefix: ''

            cloudify_agent:
                min_workers: 2
                max_workers: 5
                remote_execution_port: 22
                user: ubuntu

            workflows:
                task_retries: -1  # this means forever
                task_retry_interval: 30

            policy_engine:
                start_timeout: 30

outputs:

    manager_ip:
        value: { get_input: public_ip }


node_templates:
    manager_host:
        type: cloudify.types.host
        properties:
            install_agent: false
            ip: { get_input: public_ip }

    manager:
        type: cloudify.types.cloudify_manager
        properties:
            cloudify: { get_input: cloudify }
        relationships:
            -   type: cloudify.relationships.contained_in
                target: manager_host
        interfaces:
            cloudify.interfaces.lifecycle:
                -   configure:
                        mapping: fabric.fabric_plugin.tasks.run_task
                        properties:
                            tasks_file: scripts/configure.py
                            task_name: configure
                            task_properties:
                                private_ip: { get_input: private_ip }
                            fabric_env:
                                user: { get_input: ssh_user }
                                key_filename: { get_input: ssh_key_filename }
                -   start:
                        mapping: fabric.fabric_plugin.tasks.run_module_task
                        properties:
                            task_mapping: cloudify_cli.bootstrap.tasks.bootstrap
                            task_properties:
                                cloudify_packages: { get_input: cloudify_packages }
                                agent_local_key_path: { get_input: ssh_key_filename }
                            fabric_env:
                                user: { get_input: ssh_user }
                                key_filename: { get_input: ssh_key_filename }
